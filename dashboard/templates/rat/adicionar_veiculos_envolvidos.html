{% extends "base/base.html" %}
{% load static %}

{% block title %}Adicionar Objetos/Envolvidos/Veículos à RAT {{ rat.id }}{% endblock %}

{% block content %}
<style>
    .tabs-content.carousel.carousel-slider .carousel-item.active{
        position: relative;
    }
    .tabs-content.carousel.carousel-slider{
        height: auto !important;
    }
    .short-text { display: none; }

    @media (max-width: 470px) {
        .short-text { display: inline-block; }
        .full-text { display: none; }
    }
    div.modal-overlay { pointer-events:none; }
</style>
<script>
    function voltar(){
        if(confirm("Voltar irá excluir a ocorrência, deseja prosseguir?")){
            $.ajax({
                url: "{% url 'rat:post_delete_rat' %}",
                type: "POST",
                data: {"rat": "{{ rat.id }}"},
                success: () => {
                    history.go(-1);
                }
            });
            return false;
        } else {
            return false;
        }
    }
</script>
<div class="col s12 m12 l12">
    <div class="row">
        <div class="card darken-1 col l12 m12 s12">
            <div class="card-content text-darken-4 grey-text">
                <span class="card-title">
                    <div class="row">
                        Criar RAT
                        <button id="apagaRAT" style="float: right;" class="btn waves-effect waves-light">
                            <i class="material-icons right">delete</i>
                            <span class="full-text">Apagar RAT</span>
                            <span class="short-text">Apagar</span>
                        </button>
                    </div>
                </span>

                <div class="divider"></div>

                <!-- Objetos -->
                <div class="row">
                    <div class="col s12 m12 l12">
                        <div class="card blue-grey darken-1">
                            <div class="card-content white-text z-depth-5">
                                <span class="card-title">Objetos</span>
                                <div id="listarobjetos">
                                    <ul style="display: none;" class="collapsible black-text white row l12 m12 s12"></ul>
                                </div>
                            </div>
                            <div class="card-action">
                                <button data-target="modal-objetos" class="btn modal-trigger">
                                    <i class="material-icons left">add</i>
                                    <span class="full-text">Inserir Objetos</span>
                                    <span class="short-text">Inserir</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="modal-objetos" class="modal modal-fixed-footer">
                    <div class="modal-content">
                        {% include "rat/includes/objetos.html" %}
                    </div>
                    <div class="modal-footer">
                        <a class="modal-close waves-effect waves-light btn">
                            <i class="material-icons left">close</i>Fechar
                        </a>
                    </div>
                </div>
                <!-- -->

                <!-- Veículos -->
                <div class="row">
                    <div class="col s12 m12 l12">
                        <div class="card blue-grey darken-1">
                            <div class="card-content white-text z-depth-5">
                                <span class="card-title">Veículos</span>
                                <div id="listarveiculos">
                                    <ul style="display: none;" class="collapsible black-text white row l12 m12 s12"></ul>
                                </div>
                            </div>
                            <div class="card-action">
                                <button data-target="modal-veiculos" class="btn modal-trigger">
                                    <i class="material-icons left">add</i>
                                    <span class="full-text">Inserir Veículos</span>
                                    <span class="short-text">Inserir</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="modal-veiculos" class="modal modal-fixed-footer">
                    <div class="modal-content">
                        {% include "rat/includes/veiculos.html" %}
                    </div>
                    <div class="modal-footer">
                        <a class="modal-close waves-effect waves-light btn">
                            <i class="material-icons left">close</i>Fechar
                        </a>
                    </div>
                </div>
                <!-- -->

                <!-- Envolvidos -->
                <div class="row">
                    <div class="col s12 m12 l12">
                        <div class="card blue-grey darken-1">
                            <div class="card-content white-text z-depth-5">
                                <span class="card-title">Envolvidos</span>
                                <div id="listarenvolvidos">
                                    <ul style="display: none;" class="collapsible black-text white row l12 m12 s12"></ul>
                                </div>
                            </div>
                            <div class="card-action">
                                <button data-target="modal-envolvidos" class="btn modal-trigger">
                                    <i class="material-icons left">add</i>
                                    <span class="full-text">Inserir Envolvidos</span>
                                    <span class="short-text">Inserir</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="modal-envolvidos" class="modal modal-fixed-footer">
                    <div class="modal-content">
                        {% include "rat/includes/envolvidos.html" %}
                    </div>
                    <div class="modal-footer">
                        <a class="modal-close waves-effect waves-light btn">
                            <i class="material-icons left">close</i>Fechar
                        </a>
                    </div>
                </div>
                <!-- -->

                <!-- Anexos -->
                <div class="row">
                    <div class="col s12 m12 l12">
                        <div class="card blue-grey darken-1">
                            <div class="card-content white-text z-depth-5">
                                <span class="card-title">Anexos</span>
                                <div id="listaranexos">
                                    <ul style="display: none;" class="collapsible black-text white row l12 m12 s12"></ul>
                                </div>
                            </div>
                            <div class="card-action">
                                <button data-target="modal-anexos" class="btn modal-trigger">
                                    <i class="material-icons left">add</i>
                                    <span class="full-text">Inserir Anexos</span>
                                    <span class="short-text">Inserir</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="modal-anexos" class="modal modal-fixed-footer">
                    <div class="modal-content">
                        {% include "rat/includes/anexos.html" %}
                    </div>
                    <div class="modal-footer">
                        <a class="modal-close waves-effect waves-light btn">
                            <i class="material-icons left">close</i>Fechar
                        </a>
                    </div>
                </div>
                <!-- -->

                <div class="row">
                    <div class="col l12 m12 s12">
                        <h5><strong>Relatório da Ocorrência</strong></h5>
                    </div>
                </div>

                <form id="preview-rat">
                <div class="row">
                    <div class="input-field col l12 m12 s12">
                        <textarea class="materialize-textarea validate" id="id_relatorio" name="relatorio" required></textarea>
                        <label for="id_relatorio">Relatório da Ocorrência</label>
                    </div>
                </div>
            </div>
                
            <div class="col l12 m12 s12">
                <div class="input-field row l6 m12 s12 right">
                    <button class="btn waves-effect waves-light" type="submit">Avançar
                        <i class="material-icons right">send</i>
                    </button>
                    </form>
                </div>
                <div class="input-field row l12 m12 s12 left">
                    <button class="btn waves-effect waves-light" onclick="voltar();">Voltar
                        <i class="material-icons left">arrow_back</i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block javascript %}
<script>
$(document).ready(function(){
    window.onbeforeunload = function(e) {
        var msg = "Conclua a ocorrência!";
        e = e || window.event;

        if(e) {
            e.returnValue = msg;
        }
        return msg;
    }

    $("#apagaRAT").on("click", function(event){
        window.onbeforeunload = "";
        
        event.stopPropagation();

        if(confirm("Deseja apagar essa ocorrência?")){
            $.ajax({
                url: "{% url 'rat:post_delete_rat' %}",
                type: "POST",
                data: {"rat": "{{ rat.id }}"},
                success: (response) => {
                    M.toast({html: "RAT deletada com sucesso!", classes: "green", completeCallback: function(){ window.location.href = response.redirect }});
                }
            });
        } else {
            window.onbeforeunload = function(e) {
                var msg = "Conclua a ocorrência!";
                e = e || window.event;

                if(e) {
                    e.returnValue = msg;
                }
                return msg;
            }
            return false;
        }
    });

    $("#preview-rat").submit(function(event){
        window.onbeforeunload = "";

        event.stopPropagation();

        if(confirm("Deseja prosseguir com a ocorrência?")){
            $.ajax({
                type: "POST",
                url: "{% url 'rat:post_preview_rat' %}",
                data: {"rat": "{{ rat.id }}", "relatorio": $("#id_relatorio").val()},
                success: (response) => {
                    window.location.href = response.redirect;
                }
            });
        } else {
            window.onbeforeunload = function(e) {
                var msg = "Conclua a ocorrência!";
                e = e || window.event;

                if(e) {
                    e.returnValue = msg;
                }
                return msg;
            }
            return false;
        }
        return false;
    });
});
</script>
<script>
    {% include "rat/includes/js/deleteelemento.js" %}
</script>
{% endblock javascript %}
{% endblock content %}
